# 4장 악성 SQL 튜닝으로 초보자 탈출하기

<br>

## 4.1 SQL 튜닝 준비하기

<br>

### 4.1.2 실무적인 SQL 튜닝 절차 이해하기
- **SQL 튜닝 절차**
    - SQL문 실행결과 & 현황파악
    - 가시적
        - 테이블의 데이터 건수
        - SELECT절 컬럼 분석
        - 조건절 컬럼 분석
        - 그루핑, 정렬 컬럼
    - 비가시적
        - 실행계획
        - 인덱스 현황
        - 데이터 변경 추이
        - 업무적 특징
    - 튜닝 방향 판단 & 개선/적용

<br>

## 4.2 SQL 문 단순 수정으로 착한 쿼리 만들기

<br>

### 4.2.1 기본 키를 변형하는 나쁜 SQL문
- **튜닝 전 SQL 문**

    ```sql
    MariaDB [tuning]> SELECT *
        ->     FROM 사원
        ->     WHERE SUBSTRING(사원번호, 1, 4) = 1100 AND LENGTH(사원번호) = 5;
    +--------------+--------------+-------------+-------------+--------+--------------+
    | 사원번호     | 생년월일     | 이름        | 성          | 성별   | 입사일자     |
    +--------------+--------------+-------------+-------------+--------+--------------+
    |        11000 | 1960-09-12   | Alain       | Bonifati    | M      | 1988-08-20   |
    |        11001 | 1956-04-16   | Baziley     | Buchter     | F      | 1987-02-23   |
    |        11002 | 1952-02-26   | Bluma       | Ulupinar    | M      | 1996-12-23   |
    |        11003 | 1960-11-13   | Mariangiola | Gulla       | M      | 1987-05-24   |
    |        11004 | 1954-08-05   | JoAnna      | Decleir     | F      | 1992-01-19   |
    |        11005 | 1958-03-12   | Byong       | Douceur     | F      | 1986-07-27   |
    |        11006 | 1962-12-26   | Christoper  | Butterworth | F      | 1989-08-02   |
    |        11007 | 1962-03-16   | Olivera     | Maccarone   | M      | 1991-04-11   |
    |        11008 | 1962-07-11   | Gennady     | Menhoudj    | M      | 1988-09-18   |
    |        11009 | 1954-08-30   | Alper       | Axelband    | F      | 1986-09-09   |
    +--------------+--------------+-------------+-------------+--------+--------------+
    10 rows in set (0.142 sec)
    ```

<br>

- **튜닝 전 실행 계획**
    - type -> all
        - 테이블 풀 스캔 방식
        - 인덱스를 사용하지 않고 테이블에 바로 접근
        - 필요한 범위에만 접근하는 대신 처음부터 끝까지 스캔하기 때문에 비효율적임
    ```sql
    MariaDB [tuning]> EXPLAIN
        -> SELECT *
        -> FROM 사원
        -> WHERE SUBSTRING(사원번호, 1, 4) = 1100 AND LENGTH(사원번호) = 5;
    +------+-------------+--------+------+---------------+------+---------+------+--------+-------------+
    | id   | select_type | table  | type | possible_keys | key  | key_len | ref  | rows   | Extra       |
    +------+-------------+--------+------+---------------+------+---------+------+--------+-------------+
    |    1 | SIMPLE      | 사원   | ALL  | NULL          | NULL | NULL    | NULL | 299600 | Using where |
    +------+-------------+--------+------+---------------+------+---------+------+--------+-------------+
    1 row in set (0.005 sec)
    ```

<br>

- **튜닝 수행**
    - 테이블안에 약 30만건의 데이터가 있음
    ```sql
    MariaDB [tuning]> SELECT COUNT(1) FROM 사원;
    +----------+
    | COUNT(1) |
    +----------+
    |   300024 |
    +----------+
    1 row in set (0.064 sec)
    ```

    <br>

    - **테이블을 구성하는 기본 키와 인덱스 현황**
        - 튜닝해야할 SQL 문 ?
            - 튜닝 전 SQL 문에서는 사원번호 열을 WHERE 절에 사용했으므로 기본 키를 통해 데이터에 빠르게 접근
            - 그러나, 사원번호를 그대로 쓰는 대신 substring을 통해 가공했음
            - 그래서 `기본 키를 사용하지 않고 테이블 풀 스캔을 수행하게 된 것임`
    ```sql
    MariaDB [tuning]> SHOW INDEX FROM 사원;
    +--------+------------+----------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+
    | Table  | Non_unique | Key_name       | Seq_in_index | Column_name  | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Ignored |
    +--------+------------+----------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+
    | 사원   |          0 | PRIMARY        |            1 | 사원번호     | A         |      299600 |     NULL | NULL   |      | BTREE      |         |               | NO      |
    | 사원   |          1 | I_입사일자     |            1 | 입사일자     | A         |        4681 |     NULL | NULL   |      | BTREE      |         |               | NO      |
    | 사원   |          1 | I_성별_성      |            1 | 성별         | A         |           1 |     NULL | NULL   |      | BTREE      |         |               | NO      |
    | 사원   |          1 | I_성별_성      |            2 | 성           | A         |        3483 |     NULL | NULL   |      | BTREE      |         |               | NO      |
    +--------+------------+----------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+
    4 rows in set (0.006 sec)
    ```

<br>

- **튜닝 결과**
    - **튜닝 후 SQL 문**
        - 기본 키인 사원번호를 변형하지 않고 작성
        - `0.1 sec -> 0.005 sec`
    ```sql
    MariaDB [tuning]> SELECT * FROM 사원 WHERE 사원번호 BETWEEN 11000 AND 11009;
    +--------------+--------------+-------------+-------------+--------+--------------+
    | 사원번호     | 생년월일     | 이름        | 성          | 성별   | 입사일자     |
    +--------------+--------------+-------------+-------------+--------+--------------+
    |        11000 | 1960-09-12   | Alain       | Bonifati    | M      | 1988-08-20   |
    |        11001 | 1956-04-16   | Baziley     | Buchter     | F      | 1987-02-23   |
    |        11002 | 1952-02-26   | Bluma       | Ulupinar    | M      | 1996-12-23   |
    |        11003 | 1960-11-13   | Mariangiola | Gulla       | M      | 1987-05-24   |
    |        11004 | 1954-08-05   | JoAnna      | Decleir     | F      | 1992-01-19   |
    |        11005 | 1958-03-12   | Byong       | Douceur     | F      | 1986-07-27   |
    |        11006 | 1962-12-26   | Christoper  | Butterworth | F      | 1989-08-02   |
    |        11007 | 1962-03-16   | Olivera     | Maccarone   | M      | 1991-04-11   |
    |        11008 | 1962-07-11   | Gennady     | Menhoudj    | M      | 1988-09-18   |
    |        11009 | 1954-08-30   | Alper       | Axelband    | F      | 1986-09-09   |
    +--------------+--------------+-------------+-------------+--------+--------------+
    10 rows in set (0.005 sec)
    ```

<br>

- **튜닝 후 실행계획**
    - `type all -> range`
        - 테이블 풀 스캔이 아닌 특정 범위만 스캔하도록 바뀜
    ```sql
    MariaDB [tuning]> EXPLAIN SELECT * FROM 사원 WHERE 사원번호 BETWEEN 11000 AND 11009;
    +------+-------------+--------+-------+---------------+---------+---------+------+------+-------------+
    | id   | select_type | table  | type  | possible_keys | key     | key_len | ref  | rows | Extra       |
    +------+-------------+--------+-------+---------------+---------+---------+------+------+-------------+
    |    1 | SIMPLE      | 사원   | range | PRIMARY       | PRIMARY | 4       | NULL | 10   | Using where |
    +------+-------------+--------+-------+---------------+---------+---------+------+------+-------------+
    1 row in set (0.009 sec)
    ```

<br>

### 4.2.2 사용하지 않는 함수를 포함하는 나쁜 SQL 문
- **튜닝 전 SQL 문**
    ```sql
    MariaDB [tuning]> SELECT IFNULL(성별, 'NO DATA') AS 성별, COUNT(1) 건수
    -> FROM 사원
    -> GROUP BY IFNULL(성별, 'NO DATA');
    +--------+--------+
    | 성별   | 건수   |
    +--------+--------+
    | F      | 120051 |
    | M      | 179973 |
    +--------+--------+
    2 rows in set (0.248 sec)
    ```

<br>

- **튜닝 전 실행계획**
    - `type -> index` / `key -> I_성별_성`
        - 인덱스 풀 스캔 방식으로 수행
    - Extra -> Using temporary
        - 임시 테이블을 생성함
    ```sql
    MariaDB [tuning]> EXPLAIN SELECT IFNULL(성별, 'NO DATA') AS 성별, COUNT(1) 건수 FROM 사원 GROUP BY IFNULL(성별, 'NO DATA');
    +------+-------------+--------+-------+---------------+--------------+---------+------+--------+----------------------------------------------+
    | id   | select_type | table  | type  | possible_keys | key          | key_len | ref  | rows   | Extra                                        |
    +------+-------------+--------+-------+---------------+--------------+---------+------+--------+----------------------------------------------+
    |    1 | SIMPLE      | 사원   | index | NULL          | I_성별_성    | 51      | NULL | 299600 | Using index; Using temporary; Using filesort |
    +------+-------------+--------+-------+---------------+--------------+---------+------+--------+----------------------------------------------+
    1 row in set (0.022 sec)
    ```

<br>

- **튜닝 수행**
    - 성별 테이블에는 NULL 값이 존재하지 않음
    - `desc 사원` 명령어를 통해 확인하면 성별 속성은 NOT NULL로 만들어짐
    - 따라서, `IFNULL() 함수를 처리하려고 DB 내부적으로 별도의 임시 테이블을 만들 필요가 없음`

<br>

- **튜닝 결과**
    - **튜닝 후 SQL 문**
        - IFNULL() 함수 제거
        - `0.248 sec -> 0.092 sec`
    ```sql
    MariaDB [tuning]> SELECT 성별, COUNT(1) 건수
    -> FROM 사원
    -> GROUP BY 성별;
    +--------+--------+
    | 성별   | 건수   |
    +--------+--------+
    | M      | 179973 |
    | F      | 120051 |
    +--------+--------+
    2 rows in set (0.092 sec)
    ```

<br>

- **튜닝 후 실행계획**
    - `Extra -> Using index`
        - 임시 테이블 없이 인덱스만 사용하여서 데이터 추출 가능
    ```sql
    MariaDB [tuning]> EXPLAIN SELECT 성별, COUNT(1) 건수 FROM 사원 GROUP BY 성별;
    +------+-------------+--------+-------+---------------+--------------+---------+------+--------+-------------+
    | id   | select_type | table  | type  | possible_keys | key          | key_len | ref  | rows   | Extra       |
    +------+-------------+--------+-------+---------------+--------------+---------+------+--------+-------------+
    |    1 | SIMPLE      | 사원   | index | NULL          | I_성별_성    | 51      | NULL | 299600 | Using index |
    +------+-------------+--------+-------+---------------+--------------+---------+------+--------+-------------+
    1 row in set (0.001 sec)
    ```

<br>

### 4.2.3 형변환으로 인덱스를 활용하지 못하는 나쁜 SQL 문
- **튜닝 전 SQL 문**
    ```sql
    MariaDB [tuning]> SELECT COUNT(1)
    -> FROM 급여
    -> WHERE 사용여부=1;
    +----------+
    | COUNT(1) |
    +----------+
    |    42842 |
    +----------+
    1 row in set (0.820 sec)
    ```

<br>

- **튜닝 전 실행계획**
    - `type -> index`
        - 인덱스 풀 스캔 방식 사용
    - filtered = 10.00
        - 엔진으로 가져온 데이터 중 10%만 추출해서 출력한 것임
    ```sql
    MariaDB [tuning]> EXPLAIN SELECT COUNT(1) FROM 급여 WHERE 사용여부=1;
    +------+-------------+--------+-------+----------------+----------------+---------+------+---------+--------------------------+
    | id   | select_type | table  | type  | possible_keys  | key            | key_len | ref  | rows    | Extra                    |
    +------+-------------+--------+-------+----------------+----------------+---------+------+---------+--------------------------+
    |    1 | SIMPLE      | 급여   | index | I_사용여부     | I_사용여부     | 4       | NULL | 2838398 | Using where; Using index |
    +------+-------------+--------+-------+----------------+----------------+---------+------+---------+--------------------------+
    1 row in set, 1 warning (0.007 sec)
    ```

<br>

- **튜닝 수행**
    - 급여 테이블의 조건절로 작성된 사용여부 열의 데이터 건수 확인
    - 사용여부 열은 문자형인 char(1) 데이터 유형으로 구성됨
        - 이전 SQL 문에서는 `사원번호=1`로 접근을 했으므로 `내부적으로 묵시적 형변환`이 발생함
        - 그 결과 인덱스를 제대로 활용하지 못하고 전체 데이터를 스캔해서 느렸던 것
    ```sql
    MariaDB [tuning]> desc 급여;
    +--------------+---------+------+-----+---------+-------+
    | Field        | Type    | Null | Key | Default | Extra |
    +--------------+---------+------+-----+---------+-------+
    | 사원번호     | int(11) | NO   | PRI | NULL    |       |
    | 연봉         | int(11) | NO   |     | NULL    |       |
    | 시작일자     | date    | NO   | PRI | NULL    |       |
    | 종료일자     | date    | NO   |     | NULL    |       |
    | 사용여부     | char(1) | YES  | MUL |         |       |
    +--------------+---------+------+-----+---------+-------+
    5 rows in set (0.030 sec)
    ```

<br>

- **튜닝 결과**
    - **튜닝 후 SQL 문**
        - `0.820 sec -> 0.02 sec`
    - `데이터 유형에 맞게 열을 활용해야 내부적인 형변환이 일어나지 않음`
    ```sql
    MariaDB [tuning]> SELECT COUNT(1) FROM 급여 WHERE 사용여부='1';
    +----------+
    | COUNT(1) |
    +----------+
    |    42842 |
    +----------+
    1 row in set (0.020 sec)
    ```

<br>

### 4.2.4 열을 결합하여 사용하는 나쁜 SQL 문
- **튜닝 전 SQL 문**
    ```sql
    MariaDB [tuning]> SELECT *
    -> FROM 사원
    -> WHERE CONCAT(성별, ' ', 성) = 'M Radwan';
    +--------------+--------------+-------------+--------+--------+--------------+
    | 사원번호     | 생년월일     | 이름        | 성     | 성별   | 입사일자     |
    +--------------+--------------+-------------+--------+--------+--------------+
    |        10346 | 1963-01-29   | Aamod       | Radwan | M      | 1987-01-27   |
    |        16491 | 1952-12-03   | Emdad       | Radwan | M      | 1988-05-28   |
    |        18169 | 1954-09-21   | Nathalie    | Radwan | M      | 1998-03-04   |

    ...

    |       485129 | 1963-03-23   | Jouni       | Radwan | M      | 1990-08-31   |
    |       491504 | 1954-12-27   | Zeydy       | Radwan | M      | 1998-03-08   |
    |       498822 | 1955-06-15   | Boutros     | Radwan | M      | 1989-06-13   |
    +--------------+--------------+-------------+--------+--------+--------------+
    102 rows in set (0.191 sec)
    ```

<br>

- **튜닝 전 실행 계획**
    - `type -> all`
        - 테이블 풀 스캔, 데이터를 처음부터 끝까지 스캔하므로 비효율적
    ```sql
    MariaDB [tuning]> EXPLAIN SELECT * FROM 사원 WHERE CONCAT(성별, ' ', 성) = 'M Radwan';
    +------+-------------+--------+------+---------------+------+---------+------+--------+-------------+
    | id   | select_type | table  | type | possible_keys | key  | key_len | ref  | rows   | Extra       |
    +------+-------------+--------+------+---------------+------+---------+------+--------+-------------+
    |    1 | SIMPLE      | 사원   | ALL  | NULL          | NULL | NULL    | NULL | 299600 | Using where |
    +------+-------------+--------+------+---------------+------+---------+------+--------+-------------+
    1 row in set (0.045 sec)
    ```

<br>

- **튜닝 수행**
    - WHERE 절에 성별 열과 성 열로 구성된 I_성별_성 인덱스를 사용 가능
    - 이 인덱스를 활용한다면 데이터를 빠르게 조회 가능

<br>

- **튜닝 결과**
    - **튜닝 후 SQL 문**
        - `0.191 sec -> 0.018 sec`
    ```sql
    MariaDB [tuning]> SELECT *
    -> FROM 사원
    -> WHERE 성별='M' AND 성='Radwan';
    +--------------+--------------+-------------+--------+--------+--------------+
    | 사원번호     | 생년월일     | 이름        | 성     | 성별   | 입사일자     |
    +--------------+--------------+-------------+--------+--------+--------------+
    |        10346 | 1963-01-29   | Aamod       | Radwan | M      | 1987-01-27   |
    |        16491 | 1952-12-03   | Emdad       | Radwan | M      | 1988-05-28   |
    
    ...

    |       491504 | 1954-12-27   | Zeydy       | Radwan | M      | 1998-03-08   |
    |       498822 | 1955-06-15   | Boutros     | Radwan | M      | 1989-06-13   |
    +--------------+--------------+-------------+--------+--------+--------------+
    102 rows in set (0.018 sec)
    ```

<br>

- **튜닝 후 실행 계획**
    - 튜닝 전에는 약 30만건의 데이터에 접근했지만,
    - 튜닝 후에는 102 건의 데이터만 접근하므로 액세스 범위가 줄었음
    ```sql
    MariaDB [tuning]> EXPLAIN SELECT * FROM 사원 WHERE 성별='M' AND 성='Radwan';
    +------+-------------+--------+------+---------------+--------------+---------+-------------+------+-----------------------+
    | id   | select_type | table  | type | possible_keys | key          | key_len | ref         | rows | Extra                 |
    +------+-------------+--------+------+---------------+--------------+---------+-------------+------+-----------------------+
    |    1 | SIMPLE      | 사원   | ref  | I_성별_성     | I_성별_성    | 51      | const,const | 102  | Using index condition |
    +------+-------------+--------+------+---------------+--------------+---------+-------------+------+-----------------------+
    1 row in set (0.007 sec)
    ```

<br>

### 4.2.5 습관적으로 중복을 제거하는 나쁜 SQL 문
- **튜닝 전 SQL 문**
    ```sql
    MariaDB [tuning]> SELECT DISTINCT 사원.사원번호, 이름, 성, 부서번호
    -> FROM 사원
    -> JOIN 부서관리자 ON (사원.사원번호= 부서관리자.사원번호);
    +--------------+-------------+--------------+--------------+
    | 사원번호     | 이름        | 성           | 부서번호     |
    +--------------+-------------+--------------+--------------+
    |       110022 | Margareta   | Markovitch   | d001         |
    |       110039 | Vishwani    | Minakawa     | d001         |

    ...

    |       111877 | Xiaobin     | Spinelli     | d009         |
    |       111939 | Yuchang     | Weedman      | d009         |
    +--------------+-------------+--------------+--------------+
    24 rows in set (0.008 sec)
    ```

<br>

- **튜닝 전 실행 계획**
    - 두 테이블 모두 `id=1` -> 두 테이블이 `조인`한다
    - 부서관리자 테이블
        - `type -> index`
            - 인덱스 풀 스캔 방식
    - 사원 테이블
        - `type -> eq_ref`
            - 사원번호라는 기본 키를 사용해서 단 1건의 데이터를 조회하는 방식으로 조인됨
    - `Extra -> Using temporary`
        - DISTINCT를 수행하고자 별도의 임시테이블을 만들고 있음
    ```sql
    MariaDB [tuning]> EXPLAIN SELECT DISTINCT 사원.사원번호, 이름, 성, 부서번호 FROM 사원 JOIN 부서관리자 ON (사원.사원번호= 부서관리자.사원번호);
    +------+-------------+-----------------+--------+---------------+----------------+---------+-------------------------------------+------+------------------------------+
    | id   | select_type | table           | type   | possible_keys | key            | key_len | ref                                 | rows | Extra                        |
    +------+-------------+-----------------+--------+---------------+----------------+---------+-------------------------------------+------+------------------------------+
    |    1 | SIMPLE      | 부서관리자      | index  | PRIMARY       | I_부서번호     | 12      | NULL                                | 24   | Using index; Using temporary |
    |    1 | SIMPLE      | 사원            | eq_ref | PRIMARY       | PRIMARY        | 4       | tuning.부서관리자.사원번호          | 1    |                              |
    +------+-------------+-----------------+--------+---------------+----------------+---------+-------------------------------------+------+------------------------------+
    2 rows in set (0.001 sec)
    ```

<br>

- **튜닝 수행**
    - 사원 테이블의 기본 키는 사원번호
    - 즉, SELECT 절에 작성된 사원.사원번호에는 중복된 데이터가 없음
        - `DISTINCT 키워드가 필요 없는 작업`임

<br>

- **튜닝 결과**
    - **튜닝 후 SQL 문**
        - `DISTINCT 키워드` 제거
        - `0.008 sec -> 0.008 sec`
            - 그대로임 (데이터 처리량이 적어 시간으로 측정 불가함)
    ```sql
    MariaDB [tuning]> SELECT 사원.사원번호, 이름, 성, 부서번호 FROM 사원 JOIN 부서관리자 ON (사원.사원번호= 부서관리자 .사원번호);
    +--------------+-------------+--------------+--------------+
    | 사원번호     | 이름        | 성           | 부서번호     |
    +--------------+-------------+--------------+--------------+
    |       110022 | Margareta   | Markovitch   | d001         |
    |       110039 | Vishwani    | Minakawa     | d001         |

    ...

    |       111877 | Xiaobin     | Spinelli     | d009         |
    |       111939 | Yuchang     | Weedman      | d009         |
    +--------------+-------------+--------------+--------------+
    24 rows in set (0.008 sec)
    ```

<br>

- **튜닝 후 실행 계획**
    - extra 항목의 Using temporary가 삭제됨
    - `즉, 임시 테이블에서 정렬과 중복 제거를 수행하지 않아도 되므로 불필요한 작업이 제거된 것`
    ```sql
    MariaDB [tuning]> EXPLAIN SELECT 사원.사원번호, 이름, 성, 부서번호 FROM 사원 JOIN 부서관리자 ON (사원.사원번호= 부   관리자.사원번호);
    +------+-------------+-----------------+--------+---------------+----------------+---------+-------------------------------------+------+-------------+
    | id   | select_type | table           | type   | possible_keys | key            | key_len | ref                                 | rows | Extra       |
    +------+-------------+-----------------+--------+---------------+----------------+---------+-------------------------------------+------+-------------+
    |    1 | SIMPLE      | 부서관리자      | index  | PRIMARY       | I_부서번호     | 12      | NULL                                | 24   | Using index |
    |    1 | SIMPLE      | 사원            | eq_ref | PRIMARY       | PRIMARY        | 4       | tuning.부서관리자.사원번호          | 1    |             |
    +------+-------------+-----------------+--------+---------------+----------------+---------+-------------------------------------+------+-------------+
    2 rows in set (0.005 sec)
    ```